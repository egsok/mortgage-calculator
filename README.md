# Калькулятор первоначального взноса

Telegram Mini App для расчёта времени накопления на первоначальный взнос по ипотеке (или полную стоимость квартиры).

## Функциональность

### Входные данные
- **Стоимость квартиры**: 3 000 000 — 100 000 000 ₽
- **Первоначальный взнос**: 10% — 100%
- **Доход в месяц**: 50 000 — 2 000 000 ₽
- **Расходы в месяц**: 30 000 — 1 500 000 ₽
- **Уже накоплено**: 0 — 20 000 000 ₽

### Расчёт
```
Цель = Стоимость × (Взнос% / 100)
Остаток = max(0, Цель - Накоплено)
Ежемесячные накопления = Доход - Расходы
Месяцев до цели = Остаток / Ежемесячные накопления
```

### Результаты
- **Цель**: сумма первоначального взноса (или "квартира без ипотеки" при 100%)
- **При текущем темпе**: срок накопления
- **Если откладывать +50 000 ₽**: ускоренный срок
- **Если откладывать +100 000 ₽**: ещё более ускоренный срок

### Сценарии (edge cases)
1. **already_saved** — уже накоплено достаточно → показываем поздравление
2. **no_savings** — расходы >= доход → показываем предупреждение
3. **normal** — стандартный расчёт с тремя вариантами срока

### Категории срока
Адаптивные пороги в зависимости от размера взноса:

| Взнос | "Долго" | "Очень долго" |
|-------|---------|---------------|
| < 50% | 5 лет | 10 лет |
| 50-64% | 6 лет | 12 лет |
| ≥ 65% | 7 лет | 15 лет |

При превышении порогов показывается подсказка.

## Динамические подсказки

### Стоимость квартиры
| Цена | Подсказка |
|------|-----------|
| ≤ 5 млн | Студия в регионах |
| ≤ 10 млн | 1-комнатная в Москве / 2-комнатная в регионах |
| ≤ 15 млн | 2-комнатная в Москве |
| ≤ 25 млн | 3-комнатная в Москве |
| ≤ 40 млн | Большая квартира или квартира в центре |
| ≤ 60 млн | Премиум-класс |
| > 60 млн | Элитная недвижимость |

### Первоначальный взнос
| Процент | Подсказка |
|---------|-----------|
| < 20% | Минимальный взнос, высокая ставка |
| < 30% | Небольшой взнос |
| < 50% | Стандартный взнос |
| < 80% | Большой взнос — выгодные условия |
| < 100% | Почти без ипотеки |
| 100% | Покупка без ипотеки |

## Интеграция с Telegram

### Инициализация
- Используется Telegram WebApp SDK
- При запуске в браузере (не в Telegram) — mock-режим для тестирования
- Определение среды по наличию `initData`

### Haptic Feedback
- `selection` — при изменении слайдера
- `impact light` — при отпускании слайдера, переключении экранов
- `notification success` — при успешном расчёте
- `notification error` — при ошибке валидации

## Интеграция с CRM (SaleBot)

### Webhook
```
POST https://chatter.salebot.pro/api/{API_KEY}/tg_callback
```

### Payload
```json
{
  "user_id": 123456789,
  "message": {
    "action": "calculator_result",
    "apartment_price": 15000000,
    "down_payment_pct": 30,
    "income": 350000,
    "expenses": 200000,
    "savings": 200000,
    "result_months": 32,
    "target_amount": 4500000,
    "scenario_type": "normal",
    "start_param": "ad_campaign_1",
    "timestamp": "2025-01-15T12:00:00.000Z"
  }
}
```

## Технические детали

### Файловая структура
```
mortgage-calculator/
├── index.html          # Основная разметка
├── css/
│   └── style.css       # Стили (CSS Variables, анимации)
└── js/
    ├── format.js       # Форматирование чисел и дат
    ├── calculator.js   # Логика расчётов и валидация
    ├── telegram.js     # Интеграция с Telegram и SaleBot
    └── app.js          # Главный контроллер приложения
```

### Дизайн
- **Тема**: тёмная (Dark Luxury)
- **Основной цвет**: `#0F172A`
- **Акцент**: `#00D97E` (зелёный)
- **Шрифты**: Unbounded (заголовки), Manrope (текст)
- **Слайдеры**: увеличенные для удобства на мобильных (32px thumb)
- **Анимации**: плавные переходы, staggered появление элементов

### Особенности мобильной версии
- `format-detection: telephone=no` — отключение автоопределения телефонов на iOS
- Скрытый scrollbar с сохранением прокрутки
- Safe area поддержка для iPhone с чёлкой
- Компактный экран результатов для размещения на одном экране

## Деплой

### Требования
- Статический хостинг (nginx, Apache, GitHub Pages, etc.)
- HTTPS обязателен для Telegram Mini App

### Настройка бота
1. Создать Mini App через @BotFather
2. Указать URL: `https://your-domain.com/mortgage-calculator/`
3. Добавить API ключ SaleBot в `js/telegram.js`

## Локальная разработка

```bash
# Запуск локального сервера
npx http-server -p 8080

# Открыть в браузере
open http://localhost:8080
```

В браузере работает mock-режим с тестовыми данными пользователя.
